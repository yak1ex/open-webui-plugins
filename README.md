# Open WebUI Plugins

## Image Gen Plus (wip)

This is a modified version for [Image Gen (0.5.3+)](https://openwebui.com/t/justinrahb/image_gen), which appears to be derived from [Image Gen](https://openwebui.com/t/jayhay123/image_gen).

Both of these versions do not have license information. The plugin sources are public, and Open WebUI itself is released under BSD-3-Clause license, so it is assumed that the plugins are also released under a similar license.

## Development Notes

As of this writing, sufficient documentataion is not provided, therefore we need to investigate Open WebUI sources to develop plugins. Here are some notes I investigated.

### Citation event

* Handled by frontend
  * https://github.com/open-webui/open-webui/blob/b03fc97e287f31ad07bda896143959bc4413f7d2/src/lib/components/chat/Messages/Citations.svelte#L92
  * https://github.com/open-webui/open-webui/blob/b03fc97e287f31ad07bda896143959bc4413f7d2/src/lib/components/chat/Messages/CitationsModal.svelte#L49
* Sumary of child elements of `data`
  * `source.name` is shown in the chat space with a link to show modal dialog.
  * If there are no `document` elements, there is no content in the dialog.
  * `document[]`, `metadata[]` and `distance[]` are corresponding by index. For example, `metadata[0]` describes `document[0]`. On the other hand, `source` is shared by documents.
  * There are `metadata[].page` for Source and `distance[]` for Relevance in Source. Details omitted here.
  * Source
    * If `metadata[].file_id` is present, `/api/v1/files/<file_id>/content` is used for the URL instead of `source.url`.
    * `source.url` should include the string `http`. Without it, `#` is used for a URL.
    * `metadata[].name` (if present) or `source.name` is shown with a link to the URL above.
  * Content
    * If `metadata[].html` is True, `document[]` is embedded in `srcdoc` of `<iframe>`.

### Image generation

* DEFAULT_IMAGE_PROMPT_GENERATION_PROMPT_TEMPLATE
https://github.com/open-webui/open-webui/blob/b03fc97e287f31ad07bda896143959bc4413f7d2/backend/open_webui/config.py#L1200
* Backend API: image_generations()
https://github.com/open-webui/open-webui/blob/b03fc97e287f31ad07bda896143959bc4413f7d2/backend/open_webui/routers/images.py#L468
  * ComfyUI and a1111 can handle a `negative_prompt` parameter.
  * Multiple images can be generated by specifying `n` parameter. This parameter is passed through to image generators.
* Generated images are returned as URL `/api/v1/files/<file_id>/content`.
  * This URL is handled by get_file_content_by_id() https://github.com/open-webui/open-webui/blob/b03fc97e287f31ad07bda896143959bc4413f7d2/backend/open_webui/routers/files.py#L230
    * `Content-Disposition` HTTP header is added except for `text/plain` files, so image file is downloaded if the URL is accessed by a browser.
    * `/api/v1/files/<file_id>/content/html` is used to display images.
    * `/api/v1/files/<file_id>` is a JSON including parameters passed to the image generator.

### Tool

* `DEFAULT_TOOLS_FUNCTION_CALLING_TEMPLATE`
https://github.com/open-webui/open-webui/blob/b03fc97e287f31ad07bda896143959bc4413f7d2/backend/open_webui/config.py#L1344
* Called from `chat_completion_tools_handler()`
https://github.com/open-webui/open-webui/blob/b03fc97e287f31ad07bda896143959bc4413f7d2/backend/open_webui/utils/middleware.py#L102
  * If `str` is returned, `citation` event is emitted as described in https://docs.openwebui.com/features/plugin/tools/#citations
  * `tools` are collected here: `get_tools()` https://github.com/open-webui/open-webui/blob/b03fc97e287f31ad07bda896143959bc4413f7d2/backend/open_webui/utils/tools.py#L38
    * extra parameters are prepared also here: `process_chat_payload()` https://github.com/open-webui/open-webui/blob/b03fc97e287f31ad07bda896143959bc4413f7d2/backend/open_webui/utils/middleware.py#L625